%---------------------------------------------------------------------------%
% Copyright 2015 Remko Duursma, Jeff Powell                                 %
%                                                                           %
% This file is part of HIERmanual                                           %
%                                                                           %
%     HIERmanual is free software: you can redistribute it and/or modify    %
%     it under the terms of the GNU General Public License as published by  %
%     the Free Software Foundation, either version 3 of the License, or     %
%     (at your option) any later version.                                   %
%                                                                           % 
%     HIERmanual is distributed in the hope that it will be useful,         %
%     but WITHOUT ANY WARRANTY; without even the implied warranty of        %
%     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the         %
%     GNU General Public License for more details.                          %
%                                                                           %
%     You should have received a copy of the GNU General Public License     %
%     along with HIERmanual.  If not, see <http://www.gnu.org/licenses/>.   %
%---------------------------------------------------------------------------%

```{r child="exercise_colorcodingexplained.Rnw", eval=TRUE}
```

### One-way ANOVA

\begin{enumerate}
\item \easy For the Titanic data (see Section~\ref{sec:titanic}, p.~\pageref{sec:titanic}), use a one-way ANOVA to compare the average passenger age by passenger class. (Note: by default, `lm` will delete all observations where `Age` is missing.)
```{r }
# Read data
titanic <- read.table("titanic.txt", header=TRUE)

fit <- lm(Age~PClass, data=titanic)
summary(fit)
```


\item \easy For the Age and Memory data (Section~\ref{sec:agemem}, p.~\pageref{sec:agemem}), make a subset of the `Older` subjects, and conduct a one-way ANOVA to compare words remembered by memory technique.
```{r }
memory <- read.table("eysenck.txt", header=TRUE)
memOlder <- subset(memory, Age=="Older")
fit <- lm(Words~Process, data=memOlder)
summary(fit)
```

\end{enumerate}

### Two-way ANOVA

\begin{enumerate}
\item \easy Using the pupae dataset, fit a two-way ANOVA to compare `PupalWeight` to `Gender` and `CO2\_treatment`. Which main effects are significant? After reading in the pupae data, make sure to convert `Gender` and `CO2\_treatment` to a factor first (see Section~\ref{sec:workingfactors}, p.~\pageref{sec:workingfactors}).
```{r }
pupae <- read.csv("pupae.csv")
pupae$CO2_treatment <- as.factor(pupae$CO2_treatment)

fit <- lm(PupalWeight ~ Gender+CO2_treatment, data=pupae)
summary(fit)

library(car)
Anova(fit)
```


\item \easy Is there an interaction between `Gender` and `CO2\_treatment`?
```{r }
# To test the interaction, add all terms (using *), and inspect the p-value for the interaction 
# term in the ANOVA table.
fit <- lm(PupalWeight ~ Gender*CO2_treatment, data=pupae)
Anova(fit)
```


\item \easy Repeat the above using `T\_treatment` instead of `CO2\_treatment`.
```{r }
fit <- lm(PupalWeight ~ Gender+T_treatment, data=pupae)
summary(fit)
Anova(fit)
fit <- lm(PupalWeight ~ Gender*T_treatment, data=pupae)
Anova(fit)
```


\item \intermed Recall Exercise~\ref{sec:ifvariance} (p.~\pageref{sec:ifvariance}). Perform a two-way ANOVA to test irrigation and fertilisation effects on tree diameter. Compare the results. *Hint*: the treatments are not coded by 'irrigation' or 'fertilization', you must first make two new variables based on the `treat` variable in the dataframe.

```{r }
hfeif2012 <- read.csv("HFEIFplotmeans2012.csv")

# One-way anova on 'treatment'
iflm <- lm(diameter ~ treat, data=hfeif2012)

library(car)
Anova(iflm)

# For Two-way anova, we have to split the treatments.
# First inspect the levels:
levels(hfeif2012$treat)

# Now split manually:
hfeif2012$Fert_treat <- as.factor(ifelse(hfeif2012$treat %in% c("F","IL"),
                                         "fertilized", "control"))
hfeif2012$Irrig_treat <- as.factor(ifelse(hfeif2012$treat %in% c("I","IL"),
                                         "irrigated", "control"))

# Double-check that the order of the levels is
# 'control' and then 'irrigated' or 'fertilized'.
levels(hfeif2012$Fert_treat)
levels(hfeif2012$Irrig_treat)

# Perform Two-way ANOVA
lmif2 <- lm(diameter ~ Fert_treat*Irrig_treat, data=hfeif2012)
Anova(lmif2)

# Useful to look at the effects plot:
library(effects)
plot(allEffects(lmif2))
```



\end{enumerate}


### Multiple regression
{#sec:multregexerc}

\begin{enumerate}
\item \intermed Using the Pulse data (see Section~\ref{sec:pulsedata}, p.~\pageref{sec:pulsedata}) fit a multiple linear regression of `Pulse1` against `Age`, `Weight` and `Height` (add the variables to the model in that order). 
\item \easy Are any terms significant at the 5\% level?
```{r }
pulse <- read.table("ms212.txt", header=TRUE)

# Fit model (without interactions)
pulse_fit <- lm(Pulse1 ~ Age+Weight+Height, data=pulse)
summary(pulse_fit)

library(car)
Anova(pulse_fit)

# Plot model diagnostics
par(mfrow=c(1,2))
residualPlot(pulse_fit)
qqPlot(pulse_fit)
```
\item \easy Generate some diagnostic plots of the fitted models.

\end{enumerate}


### Linear Model with factor and numeric variables

\begin{enumerate}
\item \easy Repeat exercise~\ref{sec:multregexerc}, and also include the factor `Exercise`. You will need to first convert `Exercise` to a factor as it is stored numerically in the CSV file. Does adding `Exercise` improve the model?

```{r }
pulse$Exercise <- as.factor(pulse$Exercise)
pulse_fit2 <- lm(Pulse1 ~ Age+Weight+Height+Exercise, data=pulse)
summary(pulse_fit2)
Anova(pulse_fit2)

# AIC shows only a very marginal improvement.
AIC(pulse_fit, pulse_fit2)
```


\item \intermed Using the same  data, fit a model of `Pulse2` as a function of `Pulse1` and `Ran` as main effects only (Note: convert `Ran` to a factor first). Use the `effects` package to inspect the model fit, and help understand the estimated coefficients in the model.
```{r }
pulse$Ran <- as.factor(pulse$Ran)
pulse_fit3 <- lm(Pulse2~Pulse1+Ran, data=pulse)
Anova(pulse_fit3) 

# It is important that you visualize this model,
# since it has a numeric and a factor variable.
library(effects)
plot(allEffects(pulse_fit3))
```


\item \intermed Now add the interaction between `Pulse1` and `Ran`. Is it significant? Also look at the effects plot, how is it different from the model without an interaction?
```{r }
pulse_fit4 <- lm(Pulse2~Pulse1*Ran, data=pulse)
Anova(pulse_fit4) 

library(effects)
plot(allEffects(pulse_fit4))
```


\item \easy Add (factor versions of) `Alcohol`, `Smokes` and `Exercise` to this model, and inspect whether the model improved.
\end{enumerate}
```{r }
pulse_fit5 <- lm(Pulse2 ~ Pulse1 + Ran + Alcohol + Smokes + Exercise, data=pulse)
Anova(pulse_fit5) 
```


### Logistic regression

\begin{enumerate}
\item \easy Using the Pulse data once more, build a model to see if `Pulse2` can predict whether people were in the `Ran` group. Make sure that `Ran` is coded as a factor.

```{r }
# This is a logistic regression, since Ran takes only two possible values.
fit6 <- glm(Ran ~ Pulse2, data=pulse, family=binomial)
summary(fit6)
```

\item \easy The `visreg` package is very helpful in visualizing the fitted model. For the logistic regression you just fit , run the following code and make sure you understand the output. (This code assumes you called the object `fit6`, if not change `fit6` to the name you used.)
\begin{verbatim}
library(visreg)
visreg(fit6, scale="response")
\end{verbatim}
```{r }
# This plot shows the fitted logistic regression (with an approximate 
# confidence interval).
# When pulse was low, the probability that the subject was in the 'Ran' group
# is very close to 1.
library(visreg)
visreg(fit6, scale="response")
```


\end{enumerate}

### Generalized linear model (GLM)

\begin{enumerate}
\item First run the following code to generate some data,
\begin{verbatim}
len <- 21
x <- seq(0,1,length=len)
y <- rpois(len,exp(x-0.5))
\end{verbatim}
```{r echo=FALSE}
len <- 21
x <- seq(0,1,length=len)
y <- rpois(len,exp(x-0.5))
```

\item \easy Fit a Poisson GLM to model `y` on `x`. Is `x` significant in the model?
```{r }
fit7 <- glm(y ~ x, family=poisson)
summary(fit7)
```

\item \easy Repeat above with a larger sample size (e.g., `len <- 101`). Compare the results.
```{r }
len <-101
x <- seq(0, 1, length=len)
y <- rpois(len, exp(x-0.5))

fit <-glm(y ~ x, family=poisson)
summary(fit)
```

\item \intermed The `memory` data were analysed assuming a normal error distribution in Section~\ref{sec:twoway} and using a Poisson error distribution in Section~\ref{sec:glm}, and each approach resulted in a different outcome for the significance of the interaction term. The participants in the study were asked to remember up to 27 words, not an unlimited number, and some of the participants were remembering close to this upper limit. Therefore, it may make sense to think of the response as consisting of a number of 'successes' and a number of 'failures', as we do in a logistic regression. Use `glm` to model the response using a binomial error distribution. Refer to Section~\ref{sec:tabuldataglm} (p.~\pageref{sec:tabuldataglm}) for a similar example.

```{r }
# read in data
memory <- read.delim('eysenck.txt')

# Fit glm model, with response represented by two columns: 
# number of words remembered and not remembered, or
# 'successes' and 'failures'.
m1 <- glm(cbind(Words, 27-Words) ~ Age * Process, data=memory, family=binomial)

# estimate significance of the main effects
Anova(m1)
```

\end{enumerate}




